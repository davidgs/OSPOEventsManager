# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

### Added
- **Multi-Platform Kubernetes Deployment Support** (2025-01-21)
  - Added Google Kubernetes Engine (GKE) deployment support
    - GKE-specific Ingress with GCE annotations
    - Support for Google Container Registry (GCR) and Docker Hub
    - Automatic authentication and cluster configuration
    - Static IP and managed certificate support
  - Added Amazon Elastic Kubernetes Service (EKS) deployment support
    - EKS-specific Ingress with AWS ALB annotations
    - Support for Amazon ECR and Docker Hub
    - Automatic authentication and cluster configuration
    - ACM certificate integration
  - Refactored deployment manifests into platform-specific directories
    - `k8s/common/` - Shared manifests for all platforms
    - `k8s/openshift/` - OpenShift-specific manifests (Routes, ImageStreams, BuildConfigs)
    - `k8s/gke/` - GKE-specific manifests (Ingress)
    - `k8s/eks/` - EKS-specific manifests (Ingress)
  - Enhanced `deploy.sh` script with multi-platform support
    - Added `--gke` and `--eks` flags
    - Platform detection and automatic CLI command selection
    - External image registry build and push functionality
    - Platform-specific ingress/routes creation
  - Updated `env.template` with GKE and EKS configuration variables
    - GKE: Project ID, cluster name, region, image registry settings
    - EKS: Cluster name, region, account ID, ECR settings, certificate ARN
    - Storage class configuration for cloud providers
  - Maintained full backward compatibility with existing OpenShift deployments
  - All four deployment environments now supported: OpenShift, GKE, EKS, Local/KIND
- **Internationalization (i18n) Support** (2025-01-21)
  - Comprehensive internationalization infrastructure using react-i18next
  - Language selection UI component in Header and Settings page
  - Dual storage for language preferences (database + localStorage)
  - Locale-aware date, number, and currency formatting utilities
  - Translation files organized by namespace (common, navigation, forms, pages, events, assets, cfp, attendees, modals)
  - API endpoints for user language preference management (`GET/PUT /api/users/:id/language`)
  - Full translation support across all application components:
    - **Layout Components**: Header, Footer, Sidebar, MainLayout, ProtectedRoute
    - **Page Components**: HomePage, Settings
    - **Form Components**: AssetUploadForm, CFPSubmissionForm, AttendanceForm, SimpleFileUploadForm, SimpleFileUploader
    - **Modal Components**: AddEventModal, DeleteEventDialog, LinkAssetModal, AssetPreviewModal
    - **UI Components**: ThemeToggle, LanguageSelector
    - **Auth Components**: LoginButton, LogoutButton
  - Translation namespaces:
    - `common`: Common UI strings (buttons, labels, messages)
    - `navigation`: Navigation menu items
    - `forms`: Form labels, placeholders, validation messages
    - `pages`: Page-specific content
    - `events`: Event-related strings
    - `assets`: Asset management strings
    - `cfp`: CFP submission strings
    - `attendees`: Attendee management strings
    - `modals`: Modal dialog strings
  - Language detection order: database preference → localStorage → browser → 'en'
  - Support for adding additional languages in the future (infrastructure ready for es, fr, de, ja, zh-CN)
  - Initial language support: English (en)
  - Locale-aware formatting:
    - Dates formatted using date-fns with locale support
    - Numbers and currency formatted using Intl.NumberFormat
    - All user-facing strings use translation keys
- **Comprehensive Documentation System** (2025-10-30)
  - Created `/docs` directory with structured documentation
  - User guides: getting started (250+ lines), managing events (350+ lines), comprehensive FAQ (500+ lines)
  - Developer documentation: architecture overview (450+ lines), deployment guide
  - Admin guides: user management, event review, system settings (placeholders)
  - General documentation: troubleshooting, requirements, support
  - Documentation viewer React component with sidebar navigation
  - Backend API endpoint (`/api/docs/*`) to serve markdown files
  - "Docs" button in application header for easy access
  - Mobile-responsive documentation interface
  - Total: 1500+ lines of documentation
- **Flow Diagram Documentation** (`FLOW_DIAGRAM.md`)
  - Complete system architecture diagrams
  - User authentication flow
  - API request flow with middleware stack
  - File upload flow
  - Deployment flow (OpenShift)
  - Data model relationships
  - Security architecture (defense in depth)
  - Environment-specific configurations
  - Technology stack summary
- **Environment Configuration Enhancements**
  - Updated `env.template` with 29 additional configuration variables
  - Added session configuration options
  - Added rate limiting configuration
  - Added CSP (Content Security Policy) configuration
  - Added Helmet security headers configuration
  - Added proxy configuration options
  - Added MinIO connection details for application usage
  - Added AI configuration (OLLAMA_MODEL)
  - Added VITE_KEYCLOAK_URL for active environment
  - Total: 120 configuration variables in template (up from 91)
- **Standardized Local Development with KIND** (2025-10-31)
  - Added `--local` flag to `configure.sh` for local environment setup
    - Automatically copies `env.local.template` to `.env.local`
    - Pre-configured with localhost settings for all services
    - No manual configuration needed for local development
  - Added `--local` flag to `deploy.sh` for KIND cluster deployment
    - Creates and manages local KIND (Kubernetes in Docker) cluster
    - Deploys PostgreSQL, Keycloak, and MinIO to local cluster
    - Uses NodePort services for localhost access (5432, 8080, 9000, 9001)
    - Individual service deployment support (`--postgres`, `--keycloak`, `--minio`)
    - Follows same deployment patterns as production (dev/prod)
  - Integrated KIND cluster management into `deploy.sh`
    - `setup_kind_cluster()` - Creates cluster with Podman provider
    - `deploy_postgres_local()` - Deploys PostgreSQL with persistent storage
    - `deploy_keycloak_local()` - Deploys Keycloak with realm configuration
    - `deploy_minio_local()` - Deploys MinIO object storage
    - `create_nodeport_services_local()` - Sets up localhost access via NodePort
    - `delete_local_cluster()` - Removes KIND cluster and all data
  - Added prerequisite checking for local development
    - Validates kubectl, kind, and podman installation
    - Checks and starts Podman machine automatically
    - Verifies KIND cluster exists or creates it
  - Updated `kind/README.md` with comprehensive local development guide
    - Quick setup instructions using standardized scripts
    - Prerequisites and Podman initialization
    - Service access URLs and default credentials
    - Troubleshooting section for common issues
    - Development workflow best practices
  - Updated README with local vs production deployment sections
    - Clear prerequisites for local vs production deployment
    - Separate setup instructions for each environment
    - Service access information
  - Simplified npm scripts (removed separate KIND management scripts)
    - Removed `kind:start`, `kind:stop`, `kind:restart`, `kind:delete`, `kind:status`, `kind:logs`
    - Removed `local:setup`, `local:db-console`
    - All KIND management now through standardized `deploy.sh --local`
  - Updated `env.local.template` with correct localhost service URLs
  - Benefits:
    - Single unified deployment script for all environments
    - Consistent deployment process across local and production
    - No need for separate cluster management scripts
    - Automated prerequisite checks and validation
    - Easy switching between local and production deployments
  - Usage:
    ```bash
    ./configure.sh --local           # Setup local environment
    ./deploy.sh --local              # Deploy all services
    ./deploy.sh --local --postgres   # Deploy specific service
    ./deploy.sh --delete-local       # Delete KIND cluster
    npm run dev:local                # Run application
    ```
- **Event Creator Information Display** (2025-01-XX)
  - Added creator name and avatar display to event cards
  - Event cards now show who created each event in the footer
  - Automatic fallback to "Unknown User" when creator information is not available
  - Backend storage methods (`getEvents()` and `getEvent()`) now include creator information
    - Efficient batch fetching of creator data to avoid N+1 queries
    - Creator name and avatar attached to event objects
  - Frontend event card component updated to display creator info
    - Shows creator avatar (or initial fallback if no avatar)
    - Shows creator name (or "Unknown User" if missing)
    - Positioned in card footer alongside "View details" link
  - Added comprehensive unit tests (14 new tests)
    - Storage layer tests for creator information enrichment (4 tests)
    - Event card component tests for creator display (10 tests)
- **GitHub Actions CI/CD Pipeline** (2025-10-30)
  - Created comprehensive CI pipeline workflow (`ci.yml`)
    - Lint and TypeScript type checking job
    - Complete test suite execution (899 tests)
    - Application build verification
    - Security scanning (npm audit + Snyk)
    - Automated PR comments with test results
    - Coverage report generation and upload
  - Created dedicated test workflow (`test.yml`)
    - Runs on push and pull requests
    - Uploads test results and coverage
    - Archives artifacts for 30 days
  - Added status badges to README
    - CI Pipeline status
    - Test suite status
    - Test coverage badge (899/899 passing)
    - License badge
  - Features:
    - Automatic testing on all pushes and PRs
    - Node.js 20.x environment
    - Artifact archival (test results, build outputs)
    - NPM caching for faster builds
    - Optional Codecov integration
    - Optional Snyk security scanning
    - PR comments with detailed test results
  - Created workflow documentation in `.github/workflows/README.md`
  - All tests passing: 899/899 (100% ✅)
- **Comprehensive Unit Test Suite** (2025-10-30)
  - Created unit tests for all `shared` directory files (143 tests)
    - 100+ test cases covering database types, schemas, and validations
    - Test coverage for all enum types and validation schemas
    - Test coverage for all insert and update schemas
    - Test coverage for all database table definitions
    - Test coverage for legacy compatibility exports
    - Target coverage: 90%+ for shared module
  - Created unit tests for `server` directory files (309 tests)
    - Database configuration tests (`db.test.ts`) - 22 tests
    - Storage layer tests (`storage.test.ts`) - 47 tests
    - Keycloak authentication tests (`keycloak-config.test.ts`) - 48 tests
    - Keycloak Admin Service tests (`services/keycloak-admin-service.test.ts`) - 45 tests
    - User Service tests (`services/user-service.test.ts`) - 42 tests
    - Workflow Service tests (`services/workflow-service.test.ts`) - 65 tests
    - Covers environment detection, query patterns, authentication flows, service layer
    - Target coverage: 85%+ for server modules
  - Created unit tests for `client` directory files (554 tests)
    - Library utilities tests (`lib/utils.test.ts`) - 71 tests
      - String safety utilities, XSS protection, formatting utilities
    - Date utilities tests (`lib/date-utils.test.ts`) - 33 tests
      - Safe date parsing, formatting, and range handling
    - Constants tests (`lib/constants.test.ts`) - 34 tests
      - Validation of all application constants and enums
    - Keycloak integration tests (`lib/keycloak.test.ts`) - 52 tests
      - Authentication flow, token management, user info extraction
    - Query client tests (`lib/queryClient.test.ts`) - 35 tests
      - API request handling, error management, React Query integration
    - Hooks tests: use-mobile (13 tests), use-toast (27 tests)
    - Auth context tests (`contexts/auth-context.test.tsx`) - 20 tests
      - Authentication state management, role-based access, HOC protection
    - Page tests (`pages/*.test.tsx`) - 66 tests
      - home-page (14 tests), login (14 tests), not-found (6 tests)
      - unauthorized (9 tests), auth-page (17 tests), callback-page (6 tests)
      - Authenticated/unauthenticated states, navigation, loading states
    - Component tests (`components/**/*.test.tsx`) - 201 tests (100% passing ✅)
      - Auth components: LoginButton (13 tests), LogoutButton (15 tests)
      - Protected route component (18 tests) - RBAC, authentication checks
      - Theme components: theme-provider (21 tests), theme-toggle (10 tests)
      - UI Badge components: priority-badge (39 tests), status-badge (47 tests), type-badge (38 tests)
      - Fixed all async test issues with proper window.matchMedia mocking
      - Refactored dropdown menu tests to work with jsdom limitations
    - Target coverage: 80%+ for client modules
  - Added React Testing Library for component testing
  - Added jsdom for browser environment simulation
  - Added Vitest as testing framework
  - Added Vitest UI for interactive test running
  - Added test coverage reporting with v8
  - Created `vitest.config.ts` with environment-specific configuration
    - jsdom environment for client tests
    - Node environment for server/shared tests
  - Created `vitest.setup.ts` with browser API mocks
  - Created `TESTING.md` with comprehensive testing documentation
  - Created `shared/__tests__/README.md` with test suite documentation
  - Created `server/__tests__/README.md` with server test documentation
  - Created `client/__tests__/README.md` with client test documentation
  - Created `client/__tests__/components/README.md` with component test documentation
  - Created `client/__tests__/pages/README.md` with page test documentation
  - Test scripts: `npm test`, `npm run test:ui`, `npm run test:coverage`
  - Added React imports to page and component files for test compatibility
  - Fixed all async test failures with proper mocking strategies
  - **Total: 899 tests across shared, server, and client modules (899 passing, 100% pass rate ✅)**
- Users page with user management functionality
- User profile editing capabilities
- Asset ownership tracking and management
- Approval workflows system
- CFP submissions management
- Attendees management
- Sponsorships management
- Stakeholders management
- CSV import functionality for events
- File upload system with security validation
- Keycloak integration for authentication
- PostgreSQL database integration
- Docker containerization
- OpenShift deployment configuration
- Persistent file storage configuration (10Gi PVCs for uploads and database)

### Changed
- **Keycloak Realm Configuration** (2025-10-30)
  - Updated `keycloak-realm-export.json` to include custom domain redirect URIs
  - Added `*.rh-events.org`, `dev.rh-events.org`, and `rh-events.org` to valid redirect URIs
  - Added matching web origins for proper CORS handling
  - Removed redundant `prod.rh-events.org` (now using root domain)
  - Removed OpenShift cluster-specific URLs (consolidated to custom domains)
- **Documentation Integration**
  - Modified `server/routes.ts` to add documentation endpoint with security
  - Updated `client/src/App.tsx` to add documentation routes
  - Enhanced `client/src/components/layout/Header.tsx` with Docs button
  - Added `react-markdown` dependency for Markdown rendering
- **Configuration Improvements**
  - Synchronized all environment variables between `.env` and `env.template`
  - Documented all 120 configuration options in template
  - Added comprehensive comments for each configuration section
- Fixed invalid image reference in deployment configuration
- Updated Dockerfile to use fully qualified image names
- Enhanced Content Security Policy configuration
- Improved error handling throughout the application
- Updated authentication middleware
- Enhanced file upload security with type validation

### Fixed
- Resolved linting errors in `server/routes.ts` and `server/vite.ts`
- Fixed TypeScript type assertions and error handling
- Corrected `import.meta.dirname` usage in Node.js environment
- Fixed asset property access in frontend components
- Resolved CSP directive quoting issues
- Fixed environment variable substitution in deployment scripts
- **Asset Persistence**: Fixed asset loss on app restarts by configuring `UPLOADS_DIR` to use persistent volume
- **Asset Ownership**: Fixed "Unknown User" display by using `uploadedByName` from backend response instead of complex user lookups
- **Event Editing**: Fixed "Invalid time value" error when editing events by adding safe date parsing with proper validation
- **CFP Submissions API**: Fixed 500 error by adding missing `created_at` and `updated_at` columns to `cfp_submissions` table
- **EditEventModal**: Fixed missing imports (`cn`, `Checkbox`, and `format`) that were causing ReferenceError crashes
- **Event Creator Tracking**: Fixed missing `created_by_id` field by automatically populating it with the authenticated user's database ID when creating events
- **Creator/Edit History System**: Implemented comprehensive tracking system for who created and edited entities
  - Added `created_by_id` and `updated_by_id` fields to events and assets tables
  - Created `edit_history` table to track all entity modifications
  - Updated backend APIs to automatically populate creator/edit tracking fields
  - Added `/api/edit-history/:entityType/:entityId` endpoint for fetching edit history
  - Created `CreatorInfo` and `EditHistory` React components for displaying creator/editor information
  - **CRITICAL FIX**: Updated database initialization scripts (`init-db.ts` and `init-db.sql`) to include new columns, ensuring schema persistence across PostgreSQL redeployments
- **Event Editing**: Fixed EditEventModal issues
  - Made event goals optional (removed required validation)
  - Fixed field name mismatch between frontend and backend (`startDate` → `start_date`, `endDate` → `end_date`, `cfpDeadline` → `cfp_deadline`, `goals` → `goal`)
  - Fixed "Update Event" button functionality
  - Removed red asterisk (*) from Event Goals field to indicate it's optional
- **Authentication**: Fixed 401 error handling
  - Added automatic redirect to login page when authentication tokens expire
  - App now properly handles expired tokens by clearing auth state and redirecting to login
- **Event Mutations**: Fixed success handling for event operations
  - Fixed add/edit/delete event mutations to properly handle API responses
  - EditEventModal now closes automatically on successful update
  - Added proper error handling and success feedback for all event operations
- **Documentation Endpoint**: Fixed 401 Unauthorized error on documentation access (2025-10-30)
  - Added `/api/docs/*` to list of public endpoints
  - Documentation now accessible without authentication
  - Updated both authenticated and fallback security middleware

### Security
- **Keycloak Domain Configuration** (2025-10-30)
  - Fixed Keycloak hostname misconfiguration preventing login
  - Ensured `keycloak-prod.rh-events.org` is properly configured
  - Updated redirect URIs to support custom domains
  - Enhanced CORS configuration for custom domains
- **Documentation Endpoint Security**
  - Implemented path traversal protection in documentation API
  - Sanitizes file paths to prevent directory traversal attacks
  - Validates file existence before serving
  - Proper error handling for security-related failures
- Implemented comprehensive file upload validation
- Added rate limiting middleware
- Enhanced input sanitization
- Improved authentication and authorization
- Added secure filename generation
- Implemented directory traversal protection

## [1.0.0] - 2024-01-XX

### Added
- Initial release of Events Manager
- Basic event management functionality
- User authentication system
- Database schema and migrations
- API endpoints for core functionality
- React frontend with TypeScript
- Express.js backend with security middleware
- Docker and Kubernetes deployment configurations

---

## Development Notes

### Recent Fixes (Current Session)
- **Linting Errors**: Fixed all TypeScript linting errors in server files
  - Proper error handling with type guards
  - Fixed CSV column mapping type assertions
  - Resolved Vite import issues with TypeScript ignore comments
  - Fixed Node.js compatibility issues with `__dirname` vs `import.meta.dirname`

- **Asset Management**: Fixed property access issues in frontend
  - Corrected `uploaded_by_name` to `uploadedByName` property access
  - Added proper type assertions for server-enhanced objects

- **Deployment Issues**: Resolved various deployment problems
  - Fixed invalid image reference with double slashes
  - Added Docker Hub pull secrets for base image authentication
  - Fixed environment variable export issues in deployment scripts

### Known Issues
- Users page currently shows only 1 user (David Simmons) - may need additional user seeding
- Some Keycloak integration features may need further testing
- File upload size limits and type restrictions may need adjustment based on usage

### Next Steps
- **Documentation Expansion**
  - Complete user documentation: CFP submissions, file uploads, user profile, approval workflows
  - Create admin documentation: user management, event review, system settings, backup/restore procedures
  - Develop developer documentation: API endpoints, database schema details, local setup, configuration guide, security practices
  - Add general documentation: system requirements, complete changelog, comprehensive troubleshooting
- Add more comprehensive user management features
- Implement bulk operations for events and assets
- Add advanced search and filtering capabilities
- Enhance reporting and analytics features
- Improve mobile responsiveness
- Add automated testing suite
- **MinIO Integration**: Currently not in use - decide to either implement fully or remove
  - Application uses direct PVC storage at `/app/uploads` (10Gi)
  - MinIO deployment exists but is not integrated into application code
  - Options: (1) Implement S3-compatible MinIO storage, or (2) Remove unused MinIO components
- **Keycloak Custom Domain Route**
  - Create OpenShift route for `keycloak-prod.rh-events.org` with Let's Encrypt certificate
  - Run created script: `create-keycloak-prod-route.sh` (if still exists)
  - Verify DNS configuration points to OpenShift router
