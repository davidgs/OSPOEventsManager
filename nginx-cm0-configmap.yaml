apiVersion: v1
data:
  nginx.conf: "events {\n    worker_connections 1024;\n}\n\nhttp {\n    # Use resolver to allow nginx to start even if upstreams are not available\n    resolver 127.0.0.11 valid=30s;\n    \n    # Include MIME types\n    include /etc/nginx/mime.types;\n    default_type application/octet-stream;\n\n    server {\n        listen 80;\n        server_name localhost;\n\n        # Health check endpoint\n        location /health {\n            access_log off;\n            return 200 \"healthy\\n\";\n            add_header Content-Type text/plain;\n        }\n\n        # Keycloak authentication routes\n        location /auth {\n            set $upstream_keycloak keycloak:8080;\n            proxy_pass http://$upstream_keycloak/auth;\n            proxy_set_header Host $host:4576;\n            proxy_set_header X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n            proxy_set_header X-Forwarded-Proto $scheme;\n            proxy_set_header X-Forwarded-Host $host:4576;\n            proxy_set_header X-Forwarded-Port 4576;\n\n            # Buffer settings for large responses\n            proxy_buffer_size 128k;\n            proxy_buffers 4 256k;\n            proxy_busy_buffers_size 256k;\n\n            # Timeout settings\n            proxy_connect_timeout 60s;\n            proxy_send_timeout 60s;\n            proxy_read_timeout 60s;\n        }\n\n        # Application routes\n        location / {\n            set $upstream_app ospo-app:4576;\n            proxy_pass http://$upstream_app/;\n            proxy_set_header Host $host;\n            proxy_set_header X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n            proxy_set_header X-Forwarded-Proto $scheme;\n            proxy_set_header X-Forwarded-Host $host;\n            proxy_set_header X-Forwarded-Port $server_port;\n\n            # WebSocket support\n            proxy_http_version 1.1;\n            proxy_set_header Upgrade $http_upgrade;\n            proxy_set_header Connection \"upgrade\";\n\n            # Timeout settings\n            proxy_connect_timeout 60s;\n            proxy_send_timeout 60s;\n            proxy_read_timeout 60s;\n        }\n    }\n}"
kind: ConfigMap
metadata:
  annotations:
    use-subpath: "true"
  labels:
    io.kompose.service: nginx
  name: nginx-cm0
